## etc_tii2soap
## templates for the turnitin V2 soap calls
## Dec 12, 2014
##

use strict;

sub tii2_soap {
return {    
    readReport => { ## check the score of a submitted paper
      url => "lis-result",
      soap => "http://www.imsglobal.org/soap/lis/oms1p0/readResult",
      args => ["messageid","sourcedid"],
      xmlresponse => \&_readReportXml,
      xml => <<XML,
<?xml version="1.0" encoding="UTF-8"?>
<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns1="http://www.imsglobal.org/services/lis/oms1p0/wsdl11/sync/imsoms_v1p0">
 <SOAP-ENV:Header><ns1:imsx_syncRequestHeaderInfo>
    <ns1:imsx_version>V1.0</ns1:imsx_version>
    <ns1:imsx_messageIdentifier>%%messageid%%</ns1:imsx_messageIdentifier>
 </ns1:imsx_syncRequestHeaderInfo></SOAP-ENV:Header>
<SOAP-ENV:Body><ns1:readResultRequest><ns1:sourcedId>%%sourcedid%%</ns1:sourcedId></ns1:readResultRequest></SOAP-ENV:Body></SOAP-ENV:Envelope>
XML
    },

    discoverPerson => { #discover a person by e-mail address
      url => "lis-person",
      soap => "http://www.imsglobal.org/soap/lis/pms2p0/discoverPersonIds",
      args => ["messageid","email"],
      response => ["tns:sourcedId"],
      xml => <<XML,
<?xml version="1.0" encoding="UTF-8"?>
<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns1="http://www.imsglobal.org/services/lis/pms2p0/wsdl11/sync/imspms_v2p0">
<SOAP-ENV:Header><ns1:imsx_syncRequestHeaderInfo>
    <ns1:imsx_version>V1.0</ns1:imsx_version>
      <ns1:imsx_messageIdentifier>%%messageid%%</ns1:imsx_messageIdentifier>
</ns1:imsx_syncRequestHeaderInfo></SOAP-ENV:Header>
<SOAP-ENV:Body><ns1:discoverPersonIdsRequest>
  <ns1:queryObject>%%email%%</ns1:queryObject>
</ns1:discoverPersonIdsRequest></SOAP-ENV:Body></SOAP-ENV:Envelope>
XML
    },

    createPerson => {# create a person which does not exist
       url => "lis-person",
       soap => "http://www.imsglobal.org/soap/lis/pms2p0/createByProxyPerson",
       args => ["messageid","firstname","lastname","email","role"],
              ## role: Instructor/Learner
       response => ["tns:sourcedId"],
       xml => <<XML,
<?xml version="1.0" encoding="UTF-8"?>
<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns1="http://www.imsglobal.org/services/lis/pms2p0/wsdl11/sync/imspms_v2p0"><SOAP-ENV:Header><ns1:imsx_syncRequestHeaderInfo>
  <ns1:imsx_version>V1.0</ns1:imsx_version>
  <ns1:imsx_messageIdentifier>%%messageid%%</ns1:imsx_messageIdentifier>
</ns1:imsx_syncRequestHeaderInfo></SOAP-ENV:Header>
<SOAP-ENV:Body><ns1:createByProxyPersonRequest>
 <ns1:personRecord><ns1:sourcedGUID><ns1:sourcedId/></ns1:sourcedGUID><ns1:person><ns1:name><ns1:nameType><ns1:instanceIdentifier><ns1:language>en-US</ns1:language><ns1:textString>1</ns1:textString></ns1:instanceIdentifier><ns1:instanceVocabulary>http://www.imsglobal.org/vdex/lis/pmsv2p0/nametypevocabularyv1p0.xml</ns1:instanceVocabulary><ns1:instanceValue><ns1:language>en-US</ns1:language><ns1:textString>Contact</ns1:textString></ns1:instanceValue></ns1:nameType>
 <ns1:partName><ns1:instanceIdentifier><ns1:language>en-US</ns1:language><ns1:textString>1</ns1:textString></ns1:instanceIdentifier><ns1:instanceVocabulary>http://www.imsglobal.org/vdex/lis/pmsv2p0/partnamevocabularyv1p0.xml</ns1:instanceVocabulary><ns1:instanceName><ns1:language>en-US</ns1:language><ns1:textString>First</ns1:textString></ns1:instanceName><ns1:instanceValue><ns1:language>en-US</ns1:language><ns1:textString>%%firstname%%</ns1:textString></ns1:instanceValue></ns1:partName>
 <ns1:partName><ns1:instanceIdentifier><ns1:language>en-US</ns1:language><ns1:textString>2</ns1:textString></ns1:instanceIdentifier><ns1:instanceVocabulary>http://www.imsglobal.org/vdex/lis/pmsv2p0/partnamevocabularyv1p0.xml</ns1:instanceVocabulary><ns1:instanceName><ns1:language>en-US</ns1:language><ns1:textString>Last</ns1:textString></ns1:instanceName><ns1:instanceValue><ns1:language>en-US</ns1:language><ns1:textString>%%lastname%%</ns1:textString></ns1:instanceValue></ns1:partName></ns1:name>
 <ns1:contactinfo><ns1:contactinfoType><ns1:instanceIdentifier><ns1:language>en-US</ns1:language><ns1:textString>1</ns1:textString></ns1:instanceIdentifier><ns1:instanceVocabulary>http://www.imsglobal.org/vdex/lis/pmsv2p0/contactinfotypevocabularyv1p0.xml</ns1:instanceVocabulary><ns1:instanceValue><ns1:language>en-US</ns1:language><ns1:textString>EmailWorkPrimary</ns1:textString></ns1:instanceValue></ns1:contactinfoType><ns1:contactinfoValue><ns1:language>en-US</ns1:language><ns1:textString>%%email%%</ns1:textString></ns1:contactinfoValue></ns1:contactinfo>
 <ns1:roles><ns1:enterpriserolesType><ns1:instanceIdentifier><ns1:language>en-US</ns1:language><ns1:textString>1</ns1:textString></ns1:instanceIdentifier><ns1:instanceVocabulary>http://www.imsglobal.org/vdex/lis/pmsv2p0/epriserolestypevocabularyv1p0.xml</ns1:instanceVocabulary><ns1:instanceName><ns1:language>en-US</ns1:language><ns1:textString>Other</ns1:textString></ns1:instanceName><ns1:instanceValue><ns1:language>en-US</ns1:language><ns1:textString>Other</ns1:textString></ns1:instanceValue></ns1:enterpriserolesType>
     <ns1:institutionRole><ns1:institutionroletype><ns1:instanceIdentifier><ns1:language>en-US</ns1:language><ns1:textString>1</ns1:textString></ns1:instanceIdentifier><ns1:instanceVocabulary>http://www.imsglobal.org/vdex/lis/pmsv2p0/institutionroletypevocabularyv1p0.xml</ns1:instanceVocabulary><ns1:instanceValue><ns1:language>en-US</ns1:language><ns1:textString>%%role%%</ns1:textString></ns1:instanceValue></ns1:institutionroletype><ns1:primaryroletype>true</ns1:primaryroletype></ns1:institutionRole>
 </ns1:roles></ns1:person></ns1:personRecord>
</ns1:createByProxyPersonRequest></SOAP-ENV:Body></SOAP-ENV:Envelope>
XML
    },

    readPerson => { ## read all data of a person
        url => "lis-person",
        soap => "http://www.imsglobal.org/soap/lis/pms2p0/readPerson",
        args => ["messageid","personid"],
        xmlresponse => \&_readPersonXml,
        xml => <<XML,
<?xml version="1.0" encoding="UTF-8"?>
<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns1="http://www.imsglobal.org/services/lis/pms2p0/wsdl11/sync/imspms_v2p0">
<SOAP-ENV:Header><ns1:imsx_syncRequestHeaderInfo>
 <ns1:imsx_version>V1.0</ns1:imsx_version><ns1:imsx_messageIdentifier>%%messageid%%</ns1:imsx_messageIdentifier>
</ns1:imsx_syncRequestHeaderInfo></SOAP-ENV:Header>
<SOAP-ENV:Body><ns1:readPersonRequest><ns1:sourcedId>%%personid%%</ns1:sourcedId></ns1:readPersonRequest>
</SOAP-ENV:Body></SOAP-ENV:Envelope>
XML
    },

    addMember => { ## createByProxyMembership, add a member to a class
       url => "lis-membership",
       soap => "http://www.imsglobal.org/soap/lis/mms2p0/createByProxyMembership",
       args => ["messageid","classid","personid","role"], ## Instructor/Learner
       response=>["tns:sourcedId"], # membership record
       xml => <<XML,
<?xml version="1.0" encoding="UTF-8"?>
<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns1="http://www.imsglobal.org/services/lis/mms2p0/wsdl11/sync/imsmms_v2p0" xmlns:ns2="http://www.imsglobal.org/services/lis/oms1p0/wsdl11/sync/imsoms_v1p0">
<SOAP-ENV:Header><ns1:imsx_syncRequestHeaderInfo>
  <ns1:imsx_version>V1.0</ns1:imsx_version>
  <ns1:imsx_messageIdentifier>%%messageid%%</ns1:imsx_messageIdentifier>
</ns1:imsx_syncRequestHeaderInfo></SOAP-ENV:Header>
<SOAP-ENV:Body><ns1:createByProxyMembershipRequest><ns1:membershipRecord><ns1:sourcedGUID><ns1:sourcedId/></ns1:sourcedGUID>
 <ns1:membership><ns1:collectionSourcedId>%%classid%%</ns1:collectionSourcedId><ns1:membershipIdType>courseSection</ns1:membershipIdType>
 <ns1:member><ns1:personSourcedId>%%personid%%</ns1:personSourcedId><ns1:role><ns1:roleType>%%role%%</ns1:roleType></ns1:role></ns1:member></ns1:membership></ns1:membershipRecord>
</ns1:createByProxyMembershipRequest></SOAP-ENV:Body></SOAP-ENV:Envelope>
XML
    },

    createClass => { # createByProxyCourseSection
       url => "lis-coursesection",
       soap => "http://www.imsglobal.org/soap/lis/cmsv1p0/createByProxyCourseSection",
       args => ["messageid","coursetitle","enddate"],
       response => ["tns:sourcedId"], ## Id of the new course
       xml => <<XML,
<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns1="http://www.imsglobal.org/services/lis/cmsv1p0/wsdl11/sync/imscms_v1p0">
<SOAP-ENV:Header><ns1:imsx_syncRequestHeaderInfo>
 <ns1:imsx_version>V1.0</ns1:imsx_version>
 <ns1:imsx_messageIdentifier>%%messageid%%</ns1:imsx_messageIdentifier>
</ns1:imsx_syncRequestHeaderInfo></SOAP-ENV:Header>
<SOAP-ENV:Body><ns1:createByProxyCourseSectionRequest>
 <ns1:courseSectionRecord><ns1:sourcedGUID><ns1:sourcedId/></ns1:sourcedGUID>
<ns1:courseSection>
  <ns1:title><ns1:language>en-US</ns1:language><ns1:textString>%%coursetitle%%</ns1:textString></ns1:title>
  <ns1:timeFrame><ns1:end>%%enddate%%</ns1:end></ns1:timeFrame>
</ns1:courseSection></ns1:courseSectionRecord>
</ns1:createByProxyCourseSectionRequest></SOAP-ENV:Body></SOAP-ENV:Envelope>
XML
    },

    createAssignment => { #createByProxyLineItemRequest
       url => "lis-lineitem",
       soap => "http://www.imsglobal.org/soap/lis/oms1p0/createByProxyLineItem",
       args => ["messageid","classid","label","startdate","duedate",
            "feedbackdate"],  ## date format: 2014-01-027T15:56:00Z
       response => ["tns:sourcedId"],
## default values:
## AuthorOriginalityAccess // Author can see report => no
## SubmittedDocumentCheck (checked against database) => yes
## InternetCheck (checked against internet source) => yes
## PublicationsCheck (against publication sources database) => yes
## MaxGrade => 100
## LateSubmissionAllowed => yes
## SubmitPapersto => 1 (Standard repository, 0: nowhere, 2: institution)
## ResubmissionRule => 1 (generate report, but can resubmit later)
## BibliographyExcluded => no
## SmallMathcExcluded => 0 (don't exclude, 1: word count, 2: percentage)
## SmallMatchExclusionThreshold => 0
## AnonymousMarking => no
## Erater => no
## TranslatedMatching => no
## AllowNonOrSubmissions => no (all submissions generate report)

       xml => <<XML,
<?xml version="1.0" encoding="UTF-8"?>
<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns1="http://www.imsglobal.org/services/lis/oms1p0/wsdl11/sync/imsoms_v1p0"><SOAP-ENV:Header><ns1:imsx_syncRequestHeaderInfo>
 <ns1:imsx_version>V1.0</ns1:imsx_version>
 <ns1:imsx_messageIdentifier>%%messageid%%</ns1:imsx_messageIdentifier>
</ns1:imsx_syncRequestHeaderInfo></SOAP-ENV:Header>
<SOAP-ENV:Body><ns1:createByProxyLineItemRequest>
 <ns1:lineItemRecord><ns1:sourcedGUID><ns1:sourcedId/></ns1:sourcedGUID><ns1:lineItem>
 <ns1:context><ns1:contextIdentifier>%%classid%%</ns1:contextIdentifier><ns1:contextType>courseSection</ns1:contextType></ns1:context>
 <ns1:label>%%label%%</ns1:label>
 <ns1:extension><ns1:extensionNameVocabulary>http://www.turnitin.com/static/source/media/turnitinvocabularyv1p0.xml</ns1:extensionNameVocabulary><ns1:extensionValueVocabulary>http://www.imsglobal.org/vdex/lis/omsv1p0/extensionvocabularyv1p0.xml</ns1:extensionValueVocabulary>
  <ns1:extensionField><ns1:fieldName>StartDate</ns1:fieldName><ns1:fieldType>DateTime</ns1:fieldType><ns1:fieldValue>%%startdate%%</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>DueDate</ns1:fieldName><ns1:fieldType>DateTime</ns1:fieldType><ns1:fieldValue>%%duedate%%</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>FeedbackReleaseDate</ns1:fieldName><ns1:fieldType>DateTime</ns1:fieldType><ns1:fieldValue>%%feedbackdate%%</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>AuthorOriginalityAccess</ns1:fieldName><ns1:fieldType>Boolean</ns1:fieldType><ns1:fieldValue>0</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>RubricId</ns1:fieldName><ns1:fieldType>Integer</ns1:fieldType><ns1:fieldValue></ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>SubmittedDocumentsCheck</ns1:fieldName><ns1:fieldType>Boolean</ns1:fieldType><ns1:fieldValue>1</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>InternetCheck</ns1:fieldName><ns1:fieldType>Boolean</ns1:fieldType><ns1:fieldValue>1</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>PublicationsCheck</ns1:fieldName><ns1:fieldType>Boolean</ns1:fieldType><ns1:fieldValue>1</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>MaxGrade</ns1:fieldName><ns1:fieldType>Integer</ns1:fieldType><ns1:fieldValue>100</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>LateSubmissionsAllowed</ns1:fieldName><ns1:fieldType>Boolean</ns1:fieldType><ns1:fieldValue>1</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>SubmitPapersTo</ns1:fieldName><ns1:fieldType>Integer</ns1:fieldType><ns1:fieldValue>1</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>ResubmissionRule</ns1:fieldName><ns1:fieldType>Integer</ns1:fieldType><ns1:fieldValue>1</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>BibliographyExcluded</ns1:fieldName><ns1:fieldType>Boolean</ns1:fieldType><ns1:fieldValue>0</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>QuotedExcluded</ns1:fieldName><ns1:fieldType>Boolean</ns1:fieldType><ns1:fieldValue>0</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>SmallMatchExclusionType</ns1:fieldName><ns1:fieldType>Integer</ns1:fieldType><ns1:fieldValue>1</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>SmallMatchExclusionThreshold</ns1:fieldName><ns1:fieldType>Integer</ns1:fieldType><ns1:fieldValue>0</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>AnonymousMarking</ns1:fieldName><ns1:fieldType>Boolean</ns1:fieldType><ns1:fieldValue>0</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>Erater</ns1:fieldName><ns1:fieldType>Boolean</ns1:fieldType><ns1:fieldValue>0</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>EraterSpelling</ns1:fieldName><ns1:fieldType>Boolean</ns1:fieldType><ns1:fieldValue>0</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>EraterGrammar</ns1:fieldName><ns1:fieldType>Boolean</ns1:fieldType><ns1:fieldValue>0</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>EraterUsage</ns1:fieldName><ns1:fieldType>Boolean</ns1:fieldType><ns1:fieldValue>0</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>EraterMechanics</ns1:fieldName><ns1:fieldType>Boolean</ns1:fieldType><ns1:fieldValue>0</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>EraterStyle</ns1:fieldName><ns1:fieldType>Boolean</ns1:fieldType><ns1:fieldValue>0</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>EraterSpellingDictionary</ns1:fieldName><ns1:fieldType>String</ns1:fieldType><ns1:fieldValue>en_US</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>EraterHandbook</ns1:fieldName><ns1:fieldType>Integer</ns1:fieldType><ns1:fieldValue>0</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>TranslatedMatching</ns1:fieldName><ns1:fieldType>Boolean</ns1:fieldType><ns1:fieldValue>0</ns1:fieldValue></ns1:extensionField>
  <ns1:extensionField><ns1:fieldName>AllowNonOrSubmissions</ns1:fieldName><ns1:fieldType>Boolean</ns1:fieldType><ns1:fieldValue>0</ns1:fieldValue></ns1:extensionField>
</ns1:extension></ns1:lineItem></ns1:lineItemRecord></ns1:createByProxyLineItemRequest></SOAP-ENV:Body></SOAP-ENV:Envelope>
XML
    },

    deleteSubmission => { # deleteResult
       url => "lis-result",
       soap => "http://www.imsglobal.org/soap/lis/oms1p0/deleteResult",
       args => ["messageid","submissionid"],
       response => [], ## no response
       xml => <<XML,
<?xml version="1.0" encoding="UTF-8"?>
<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns1="http://www.imsglobal.org/services/lis/oms1p0/wsdl11/sync/imsoms_v1p0">
<SOAP-ENV:Header><ns1:imsx_syncRequestHeaderInfo>
    <ns1:imsx_version>V1.0</ns1:imsx_version>
    <ns1:imsx_messageIdentifier>%%messageid%%</ns1:imsx_messageIdentifier>
</ns1:imsx_syncRequestHeaderInfo>
</SOAP-ENV:Header><SOAP-ENV:Body><ns1:deleteResultRequest>
  <ns1:sourcedId>%%submissionid%%</ns1:sourcedId>
</ns1:deleteResultRequest></SOAP-ENV:Body></SOAP-ENV:Envelope>
XML
    },

####################################################
## not used
####################################################

    deleteAssignment => { # deleteLineItem
       url => "lis-lineitem",
       soap => "http://www.imsglobal.org/soap/lis/oms1p0/deleteLineItem",
       args => ["messageid","assid"],
       response => ["tns:sourcedId"], ##
       xml => <<XML,
<?xml version="1.0" encoding="UTF-8"?>
<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns1="http://www.imsglobal.org/services/lis/oms1p0/wsdl11/sync/imsoms_v1p0">
<SOAP-ENV:Header><ns1:imsx_syncRequestHeaderInfo>
 <ns1:imsx_version>V1.0</ns1:imsx_version>
 <ns1:imsx_messageIdentifier>%%messageid%%</ns1:imsx_messageIdentifier>
</ns1:imsx_syncRequestHeaderInfo></SOAP-ENV:Header>
<SOAP-ENV:Body><ns1:deleteLineItemRequest>
 <ns1:sourcedId>%%assid%%</ns1:sourcedId>
</ns1:deleteLineItemRequest></SOAP-ENV:Body></SOAP-ENV:Envelope>
XML
    },

    readClass => { ## courseSection
       url => "lis-coursesection",
       soap => "http://www.imsglobal.org/soap/lis/cmsv1p0/readCourseSection",
       args => ["messageid","courseid"],
       response => ["tns:end","tns:textString"],
                 #  enddate, title
       xml => <<XML,
<?xml version="1.0" encoding="UTF-8"?>
<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns1="http://www.imsglobal.org/services/lis/cmsv1p0/wsdl11/sync/imscms_v1p0">
<SOAP-ENV:Header><ns1:imsx_syncRequestHeaderInfo>
 <ns1:imsx_version>V1.0</ns1:imsx_version>
 <ns1:imsx_messageIdentifier>%%messageid%%</ns1:imsx_messageIdentifier>
</ns1:imsx_syncRequestHeaderInfo></SOAP-ENV:Header>
<SOAP-ENV:Body><ns1:readCourseSectionRequest><ns1:sourcedId>%%courseid%%</ns1:sourcedId></ns1:readCourseSectionRequest>
</SOAP-ENV:Body></SOAP-ENV:Envelope>
XML
    },

    readAssignment => { ## read info about an assignment
       url => "lis-lineitem",
       soap => "http://www.imsglobal.org/soap/lis/oms1p0/readLineItem",
       args => ["messageid","assid"],
       xml => <<XML,
<?xml version="1.0" encoding="UTF-8"?>
<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns1="http://www.imsglobal.org/services/lis/oms1p0/wsdl11/sync/imsoms_v1p0">
<SOAP-ENV:Header><ns1:imsx_syncRequestHeaderInfo>
 <ns1:imsx_version>V1.0</ns1:imsx_version>
 <ns1:imsx_messageIdentifier>%%messageid%%</ns1:imsx_messageIdentifier></ns1:imsx_syncRequestHeaderInfo>
</SOAP-ENV:Header><SOAP-ENV:Body>
  <ns1:readLineItemRequest><ns1:sourcedId>%%assid%%</ns1:sourcedId>
</ns1:readLineItemRequest></SOAP-ENV:Body></SOAP-ENV:Envelope>
XML
    },

    discoverResult => { ## assigments in a class
       url => "lis-result",
       soap => "http://www.imsglobal.org/soap/lis/oms1p0/discoverResultIds",
       args => ["messageid","assid"], ## no datefrom
       xml => <<XML,
<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns1="http://www.imsglobal.org/services/lis/oms1p0/wsdl11/sync/imsoms_v1p0">
<SOAP-ENV:Header><ns1:imsx_syncRequestHeaderInfo>
 <ns1:imsx_version>V1.0</ns1:imsx_version>
 <ns1:imsx_messageIdentifier>%%messageid%%</ns1:imsx_messageIdentifier>
</ns1:imsx_syncRequestHeaderInfo></SOAP-ENV:Header><SOAP-ENV:Body>
  <ns1:discoverResultIdsRequest><ns1:queryObject>{"lineitem_sourcedid":"%%assid%%","date_from":null}</ns1:queryObject></ns1:discoverResultIdsRequest>
</SOAP-ENV:Body></SOAP-ENV:Envelope>
XML
    },

};}

sub _readReportXml {
    my ($D,$xml)=@_; $xml=$xml->{'SOAP-ENV:Envelope'};
    my $hdr=$xml->{'SOAP-ENV:Header'}
        ->{'tns:imsx_syncResponseHeaderInfo'}
        ->{'tns:imsx_statusInfo'};
    $D->{status} = $hdr->{'tns:imsx_codeMajor'}; # success, failure
    $D->{message} = $hdr->{'ns:imsx_description'};
    if($hdr->{'tns:imsx_codeMajor'} eq "success" &&
        $hdr->{'tns:imsx_description'} eq 'Object Result found.'){
        $xml=$xml->{'SOAP-ENV:Body'}->{'tns:readResultResponse'}->
           {'tns:resultRecord'}->{'tns:result'};
        $D->{score}=$xml->{'tns:resultScore'}->{'tns:textString'};
        $D->{teacher}=$xml->{'tns:personSourcedId'};
        $D->{title}=$xml->{'tns:resultValue'}->{'tns:label'};
        $D->{assid}=$xml->{'tns:lineItemSourcedId'};
    }
}

sub _readPersonXml {
    my ($D,$xml)=@_; $xml=$xml->{'SOAP-ENV:Envelope'};
    my $hdr=$xml->{'SOAP-ENV:Header'}
        ->{'tns:imsx_syncResponseHeaderInfo'}
        ->{'tns:imsx_statusInfo'};
    $D->{status} = $hdr->{'tns:imsx_codeMajor'}; # success, failure
    $D->{message} = $hdr->{'tns:imsx_description'};
    if($hdr->{'tns:imsx_codeMajor'} eq "success" &&
        $hdr->{'tns:imsx_description'} eq 'User Found'){
        $xml=$xml->{'SOAP-ENV:Body'}->{'tns:readPersonResponse'}->
           {'tns:personRecord'}->{'tns:person'};
        $D->{email}=$xml->{'tns:contactinfo'}->{'tns:contactinfoValue'}
                ->{'tns:textString'};
        $D->{role}=$xml->{'tns:roles'}->{'tns:institutionRole'}
                 ->{'tns:institutionroletype'}->{'tns:instanceValue'}->{'tns:textString'};
        foreach my $t(@{$xml->{'tns:extension'}->{'[]tns:extensionField'}}){
            if($t->{'tns:fieldName'} eq 'AcceptedUserAgreement'){
                $D->{eula}=$t->{'tns:fieldValue'};
            }
        }
        foreach my $t(@{$xml->{'tns:name'}->{'[]tns:partName'}}){
            if($t->{'tns:instanceName'}->{'tns:textString'} eq 'First'){
                $D->{first} = $t->{'tns:instanceValue'}->{'tns:textString'};
            }
            if($t->{'tns:instanceName'}->{'tns:textString'} eq 'Last'){
                $D->{last} = $t->{'tns:instanceValue'}->{'tns:textString'};
            }
        }
    }
}

1;

__END__
discoverPerson {email}
    D->{status}=success
    D->{tns:sourcedId}=28638196
    D->{message}=Discovered 1 user/s.
    D->{httpcode}=200
---------------------------
    D->{status}=success
    D->{message}=User not found.
    D->{httpcode}=200

createPerson {firstname,lastname,email,role}
    D->{status}=failure
    D->{message}=email - Sorry, this email already is in use
    D->{httpcode}=200
--------------------------------
    D->{status}=success
    D->{tns:sourcedId}=28638275
    D->{message}=User successfully created.
    D->{httpcode}=200

addMember {class,person,role}
    D->{status}=failure
    D->{message}=user_role - User already enrolled on this Class CourseSection
    D->{httpcode}=200
--------------------------------
    D->{status}=success
    D->{tns:sourcedId}=3815676
    D->{message}=Membership processed successfully.
    D->{httpcode}=200
